name: Testing

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: data-sync-worker
  cancel-in-progress: false

jobs:
  run-linux:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: Check Skip Job
        id: check_skip
        env:
          SKIP_JOB_ENV: ${{ vars.SKIP_JOB }}
        run: |
          should_skip="false"
          
          # Check .env file if it exists
          if [ -f .env ]; then
            if grep -q "SKIP_JOB=true" .env; then
              should_skip="true"
            fi
          fi
          
          # Check environment variable (GitHub Variable)
          if [ "$SKIP_JOB_ENV" == "true" ]; then
            should_skip="true"
          fi
          
          echo "should_skip=$should_skip" >> $GITHUB_OUTPUT
          if [ "$should_skip" == "true" ]; then
            echo "⚠️ Job is configured to be skipped."
          fi

      - name: Check pause window
        if: steps.check_skip.outputs.should_skip != 'true'
        id: checkpause
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          python - <<'PY'
          import os, time, requests
          def get_var(token, owner, repo, name):
              url = f"https://api.github.com/repos/{owner}/{repo}/actions/variables/{name}"
              r = requests.get(url, headers={"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json"})
              if r.status_code == 200:
                  return r.json().get('value')
              return None
          token = os.environ['GH_TOKEN']
          owner, repo = os.environ['GITHUB_REPOSITORY'].split('/')
          v = get_var(token, owner, repo, 'PAUSE_UNTIL')
          now = int(time.time())
          paused = 'false'
          try:
              if v and int(v) > now:
                  paused = 'true'
          except Exception:
              paused = 'false'
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'paused={paused}\n')
          PY

      - name: Write auth_state.json from secret
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        env:
          AUTH_STATE_JSON: ${{ secrets.AUTH_STATE_JSON }}
        run: |
          echo "$AUTH_STATE_JSON" > auth_state.json

      - name: Restore & Decrypt Persistent Data
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: worker_data.json.gpg
          key: persistent-data-encrypted-${{ github.run_id }}
          restore-keys: |
            persistent-data-encrypted-

      - name: Decrypt Data
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true' && steps.cache-restore.outputs.cache-hit == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase "$GPG_PASSPHRASE" \
          --output worker_data.json worker_data.json.gpg

      - name: Run Worker Script
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        env:
          # Only set CI-specific variables and secrets - let .env control the rest
          AUTH_STATE_FILE: '${{ github.workspace }}/auth_state.json'
          PROXY_IP: ${{ secrets.PROXY_IP }}
          PROXY_PORT: ${{ secrets.PROXY_PORT }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
          LOGS_WEBHOOK_URL: ${{ secrets.LOGS_WEBHOOK_URL }}
          PYTHONUNBUFFERED: 1
          GITHUB_ACTIONS: true
        run: |
          xvfb-run -a python Vps_Ready.py || true

      - name: Parse run status
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        id: parse
        run: |
          python - <<'PY'
          import json, os
          p = 'run_status.json'
          if not os.path.exists(p):
              print('status=none')
              print('reason=none')
              print('wait_hours=0')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('status=none\nreason=none\nwait_hours=0\n')
          else:
              d = json.load(open(p))
              status = (d.get('status') or 'none')
              reason = (d.get('reason') or 'none')
              wait_hours = str(d.get('wait_hours') or 0)
              print(f'status={status}')
              print(f'reason={reason}')
              print(f'wait_hours={wait_hours}')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'status={status}\nreason={reason}\nwait_hours={wait_hours}\n')
          PY

      - name: Notify Discord (limited)
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true' && steps.parse.outputs.reason != 'none' && steps.parse.outputs.reason != 'cookie_expired' && steps.parse.outputs.reason != 'no_valuebets'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          msg="Worker run entered sleep due to: ${{ steps.parse.outputs.reason }}. Waiting ${{ steps.parse.outputs.wait_hours }} hours."
          curl -H "Content-Type: application/json" -d "{\"content\": \"$msg\"}" "$DISCORD_WEBHOOK_URL"

      - name: Notify Discord (cookie expired)
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true' && steps.parse.outputs.reason == 'cookie_expired'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" -d "{\"content\": \"Cookie expired\"}" "$DISCORD_WEBHOOK_URL"

      

      - name: Update pause window (limited)
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true' && steps.parse.outputs.status == 'limited_sleep'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python - <<'PY'
          import os, time, requests
          def set_var(token, owner, repo, name, value):
              url = f"https://api.github.com/repos/{owner}/{repo}/actions/variables/{name}"
              h = {"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json"}
              r = requests.patch(url, headers=h, json={"name": name, "value": value})
              if r.status_code == 404:
                  url2 = f"https://api.github.com/repos/{owner}/{repo}/actions/variables"
                  requests.post(url2, headers=h, json={"name": name, "value": value})
          token = os.environ['GH_TOKEN']
          owner, repo = os.environ['GITHUB_REPOSITORY'].split('/')
          hours = float('${{ steps.parse.outputs.wait_hours }}' or '12')
          pause_until = str(int(time.time()) + hours * 3600)
          set_var(token, owner, repo, 'PAUSE_UNTIL', pause_until)
          PY
      - name: Encrypt & Save Cache
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -f worker_data.json ]; then
            gpg --quiet --batch --yes --symmetric --passphrase "$GPG_PASSPHRASE" \
            --output worker_data.json.gpg worker_data.json
          fi

      - name: Save Cache
        if: steps.check_skip.outputs.should_skip != 'true' && steps.checkpause.outputs.paused != 'true'
        uses: actions/cache/save@v4
        with:
          path: worker_data.json.gpg
          key: persistent-data-encrypted-${{ github.run_id }}
